# Fastlane configuration
# Docs: https://docs.fastlane.tools

default_platform(:ios)

platform :ios do
  desc "Set Info.plist Version and Build Number from pubspec via flutter_version"
  lane :set_full_version do
    version = flutter_version() # from fastlane-plugin-flutter_version
    increment_version_number(version_number: version['version_name'])
    increment_build_number(build_number: version['version_code'])
  end

  # Shared xcargs to force correct signing in CI
  def signing_xcargs
    %Q[
      -allowProvisioningUpdates
      CODE_SIGN_STYLE=Manual
      DEVELOPMENT_TEAM=DX9H87DTX5
      CODE_SIGN_IDENTITY="Apple Distribution"
      PROVISIONING_PROFILE_SPECIFIER="match AppStore com.islammob.app"
      CODE_SIGNING_ALLOWED=YES
      CODE_SIGNING_REQUIRED=YES
    ].gsub(/\s+/, ' ').strip
  end

  desc "Build and upload a new beta to TestFlight"
  lane :deploy do
    set_full_version()
    setup_ci if is_ci
    cocoapods(clean_install: is_ci)

    # Install certs/profiles via match (readonly on CI)
    match(
      type: "appstore",
      readonly: is_ci,
      app_identifier: ["com.islammob.app"],
      team_id: "DX9H87DTX5"
      # If you add new capabilities (e.g. Push/Sign in with Apple) and need a fresh profile, run once with: force: true
    )

    # Make xcodebuild settings lookup more tolerant (sometimes slow in CI)
    ENV["FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT"] = "120"
    ENV["FASTLANE_XCODEBUILD_SETTINGS_RETRIES"]  = "6"

    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      destination: "generic/platform=iOS",
      archive_path: "../build/ios/Runner.xcarchive",
      output_directory: "../build/ios/Runner",
      export_method: "app-store",
      xcargs: signing_xcargs,
      export_options: {
        provisioningProfiles: {
          "com.islammob.app" => "match AppStore com.islammob.app"
        }
      }
    )

    upload_to_testflight(
      api_key_path: "./app_store_connect.json",
      ipa: "../build/ios/Runner/Runner.ipa",
      skip_waiting_for_build_processing: true
    )
  end

  desc "Build iOS archive only (no upload)"
  lane :build_archive do
    set_full_version()
    setup_ci if is_ci
    cocoapods(clean_install: is_ci)

    match(
      type: "appstore",
      readonly: is_ci,
      app_identifier: ["com.islammob.app"],
      team_id: "DX9H87DTX5"
    )

    ENV["FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT"] = "120"
    ENV["FASTLANE_XCODEBUILD_SETTINGS_RETRIES"]  = "6"

    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      destination: "generic/platform=iOS",
      archive_path: "../build/ios/Runner.xcarchive",
      output_directory: "../build/ios/Runner",
      export_method: "app-store",
      xcargs: signing_xcargs,
      export_options: {
        provisioningProfiles: {
          "com.islammob.app" => "match AppStore com.islammob.app"
        }
      }
    )

    puts "âœ… iOS archive built successfully at ../build/ios/Runner/Runner.ipa"
  end
end
