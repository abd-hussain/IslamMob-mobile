name: CI/CD Deploy

on:
  push:
    branches:
      - main

jobs:
  android:
    runs-on: ubuntu-latest

    steps:
        - name: üìö Git Checkout
          uses: actions/checkout@v3

        - name: üî• Set Up Java
          uses: actions/setup-java@v3.12.0
          with:
            distribution: 'oracle'
            java-version: '17'

        - name: üê¶ Setup Flutter
          uses: subosito/flutter-action@v2
          with:
            flutter-version: '3.24.1'
            channel: 'stable'
            cache: true
            
        - name: üîë Set up key.properties
          run: |
            echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" > android/key.properties
            echo "storePassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
            echo "keyAlias=${{ secrets.ANDROID_KEY_Alias }}" >> android/key.properties
            echo "${{ secrets.ANDROID_KEY_CONTENT }}" | base64 --decode > android/androidkeystore.jks
            # Optional test command to verify file creation (do not log file content directly for security)
            ls -la android/ # Check if androidkeystore.jks file is generated
            
        - name: üîë Set up local.properties
          run: |
            echo "flutter.sdk=$FLUTTER_ROOT" > android/local.properties

        - name: üîë Set up Play Store Secret
          run: |
            echo "${{ secrets.PLAY_STORE_SECRET }}" | base64 --decode > android/play_store_secret.json

        - name: üéØ Setup Fastlane
          uses: ruby/setup-ruby@v1
          with:
              ruby-version: 3.3
              rubygems: latest

        - name: üîé Cleaning before we start
          run: |
              flutter clean
              rm -rf pubspec.lock
    
        - name: üõ†Ô∏è Build and Deploy
          run: |
              flutter pub get
              make deploy-android

  ios:
    runs-on: macos-latest

    steps:
        - name: üìö Set up git and fetch all history for all branches and tags
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: üê¶ Setup Flutter
          uses: subosito/flutter-action@v2
          with:
            flutter-version: '3.24.1'
            channel: 'stable'
            cache: true

        - name: Set up App Store Connect
          run: |
            echo "${{ secrets.APPSTORE_CONNECT }}" | base64 --decode > ios/app_store_connect.json

        - name: üéØ Setup Fastlane
          uses: ruby/setup-ruby@v1
          with:
            ruby-version: 3.3
            rubygems: latest
        
        - name: üì¶ Cleaning before we start
          run: |
            flutter clean
            cd ios && rm -rf Podfile.lock
            cd ios && rm -rf Pods
            cd ios && pod install
            cd ..
            flutter pub get

        - name: üõ†Ô∏è Build and Deploy
          run: |
            make deploy-ios
          env:
            MATCH_PASSWORD: ${{ secrets.IOS_MATCH_PASSWORD }}
            MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.GIT_BASIC_AUTHORIZATION }}

  